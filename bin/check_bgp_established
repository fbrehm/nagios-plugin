#!/bin/bash

PROGNAME="${0##*/}"
PROGPATH="${0%/*}"
REVISION="0.1.0"

# ProfitBricks checks are in /usr/lib/nagios/plugins/pb
#UTILS="${PROGPATH}/../utils.sh"
UTILS=/usr/lib/nagios/plugins/utils.sh
if ! [[ -e ${UTILS} ]]; then
    echo "File '${UTILS}' does not exist, aborting!"
    exit 1
fi
. /usr/lib/nagios/plugins/utils.sh

VERBOSE=0

# some funcions
print_usage() {
    echo "Usage: ${PROGNAME} [-v|--verbose]"
    echo ""
}

print_help() {
    print_revision ${PROGNAME} ${REVISION}
    echo ""
    print_usage
    echo ""
    echo "This plugin checks if all bgp connections are established."
    echo ""
    support
    exit ${STATE_OK}
}

print_verbose() {
    if [[ ${VERBOSE} -eq 1 ]]; then
        echo $1
    fi
}

# get arguments
while [[ $# -ne 0 ]]; do
    case "$1" in
        -h|--help)
            print_help
            exit ${STATE_OK}
            ;;
        -V|--version)
            print_revision ${PROGNAME} ${REVISION}
            exit ${STATE_OK}
            ;;
        -v|--verbose)
            VERBOSE=1
            shift
            ;;
        *)
            echo "Unknown argument '$1', aborting!"
            exit ${STATE_UNKNOWN}
            ;;
    esac
done

# do the work
if ! [[ -x /usr/sbin/birdc6 ]]; then
    echo "'birdc6' is not installed!"
    exit ${STATE_UNKNOWN}
fi

not_established=$(sudo /usr/sbin/birdc6 show protocols all | grep -E "^bgp" | grep -v "Established"); 

if [[ -z ${not_established} ]]; then
    echo "BGP OK: all connections established"
    exit ${STATE_OK}
else
    echo "BGP CRITICAL: ${not_establisehd}"
    exit ${STATE_CRITICAL}
fi

# vim: ts=4 sw=4 et filetype=sh
